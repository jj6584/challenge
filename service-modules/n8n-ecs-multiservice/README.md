# N8N ECS Multiservice Module

Enhanced N8N deployment module with integrated Application Load Balancer and advanced ACM certificate management. This module provides a production-ready N8N workflow automation platform with external database and Redis support.

## Features

- **🚀 Enhanced ECS Deployment**: Uses the enhanced ECS module with integrated ALB support
- **🔒 Advanced SSL/HTTPS Support**: Automatic ACM certificate lookup, creation, and management
- **🗄️ External Database Support**: Connect to external PostgreSQL (RDS or any host)
- **📁 External Redis Support**: Supports both traditional Redis and Upstash Redis
- **⚖️ Load Balancer Integration**: Application Load Balancer with health checks
- **📊 Production Ready**: Auto-scaling, logging, monitoring, and proper security groups
- **🔐 Secrets Management**: SSM Parameter Store integration for sensitive data
- **💾 Persistent Storage**: EBS volume support for N8N data

## Architecture

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Internet      │    │  Application    │    │   ECS Cluster   │
│   Gateway       │────│  Load Balancer  │────│   N8N Service   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │                        │
                              │                        │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  ACM SSL Cert   │    │  Route53 DNS    │    │  CloudWatch     │
│  (Auto-managed) │    │  (Optional)     │    │  Logs           │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                       │
                        ┌─────────────────┐    ┌─────────────────┐
                        │  External RDS   │    │  External Redis │
                        │  PostgreSQL     │    │  (Upstash/EC)   │
                        └─────────────────┘    └─────────────────┘
```

## Quick Start

### Basic Deployment with Automatic Certificate

```hcl
module \"n8n_service\" {\n  source = \"./service-modules/n8n-ecs-multiservice\"\n\n  # Core Configuration\n  environment  = \"production\"\n  project_name = \"n8n\"\n  aws_region   = \"ap-southeast-1\"\n\n  # Network Configuration\n  vpc_id                = \"vpc-12345678\"\n  subnet_ids            = [\"subnet-12345678\", \"subnet-87654321\"]\n  load_balancer_subnets = [\"subnet-public1\", \"subnet-public2\"]\n\n  # N8N Configuration\n  n8n_host = \"n8n.example.com\"\n\n  # Database Configuration (External RDS)\n  postgres_host     = \"mydb.cluster-xyz.ap-southeast-1.rds.amazonaws.com\"\n  postgres_database = \"n8n\"\n  postgres_user     = \"n8n\"\n\n  # Redis Configuration (Upstash)\n  upstash_redis_host = \"calm-aphid-47308.upstash.io\"\n  upstash_redis_port = 6379\n\n  # SSL Certificate (Automatic Lookup)\n  certificate_domain_name = \"n8n.example.com\"\n\n  # Secrets (stored in SSM Parameter Store)\n  n8n_secrets = [\n    {\n      name      = \"N8N_BASIC_AUTH_PASSWORD\"\n      valueFrom = \"arn:aws:ssm:region:account:parameter/n8n/auth/password\"\n    },\n    {\n      name      = \"DB_POSTGRESDB_PASSWORD\"\n      valueFrom = \"arn:aws:ssm:region:account:parameter/n8n/db/password\"\n    }\n  ]\n\n  task_secrets_arns = [\n    \"arn:aws:ssm:region:account:parameter/n8n/auth/password\",\n    \"arn:aws:ssm:region:account:parameter/n8n/db/password\"\n  ]\n\n  tags = {\n    Environment = \"production\"\n    Application = \"n8n\"\n  }\n}\n```\n\n### Advanced SSL Configuration\n\n#### Option 1: Automatic Certificate Creation\n\n```hcl\nmodule \"n8n_service\" {\n  source = \"./service-modules/n8n-ecs-multiservice\"\n\n  # ... other configuration ...\n\n  # SSL Certificate - Create New\n  certificate_domain_name = \"n8n.example.com\"\n  additional_certificate_subject_alternative_names = [\"www.n8n.example.com\"]\n  create_acm_certificate = true\n  certificate_validation_method = \"DNS\"\n  \n  acm_certificate_tags = {\n    Application = \"N8N\"\n    Environment = \"Production\"\n  }\n\n  ssl_policy = \"ELBSecurityPolicy-TLS13-1-2-2021-06\"\n}\n```\n\n#### Option 2: Existing Certificate ARN\n\n```hcl\nmodule \"n8n_service\" {\n  source = \"./service-modules/n8n-ecs-multiservice\"\n\n  # ... other configuration ...\n\n  # SSL Certificate - Use Existing\n  ssl_certificate_arn = \"arn:aws:acm:ap-southeast-1:123456789012:certificate/12345678-1234-1234-1234-123456789012\"\n  ssl_policy = \"ELBSecurityPolicy-TLS13-1-2-2021-06\"\n}\n```\n\n#### Option 3: Disable HTTPS (HTTP Only)\n\n```hcl\nmodule \"n8n_service\" {\n  source = \"./service-modules/n8n-ecs-multiservice\"\n\n  # ... other configuration ...\n\n  # HTTP Only Configuration\n  enable_https_listener = false\n  enable_http_listener  = true\n  http_redirect_to_https = false\n}\n```\n\n## Input Variables\n\n### Core Configuration\n\n| Variable | Description | Type | Default | Required |\n|----------|-------------|------|---------|----------|\n| `environment` | Environment name | `string` | `\"production\"` | No |\n| `project_name` | Project name for resources | `string` | `\"n8n\"` | No |\n| `aws_region` | AWS region | `string` | `\"ap-southeast-1\"` | No |\n\n### Network Configuration\n\n| Variable | Description | Type | Default | Required |\n|----------|-------------|------|---------|----------|\n| `vpc_id` | VPC ID | `string` | - | **Yes** |\n| `subnet_ids` | ECS service subnet IDs | `list(string)` | - | **Yes** |\n| `load_balancer_subnets` | ALB subnet IDs (public) | `list(string)` | - | **Yes** |\n| `load_balancer_internal` | Internal load balancer | `bool` | `false` | No |\n\n### SSL Certificate Configuration\n\n| Variable | Description | Type | Default | Required |\n|----------|-------------|------|---------|----------|\n| `ssl_certificate_arn` | Existing certificate ARN | `string` | `\"\"` | No |\n| `certificate_domain_name` | Domain for certificate lookup/creation | `string` | `\"\"` | No |\n| `create_acm_certificate` | Create new ACM certificate | `bool` | `false` | No |\n| `certificate_validation_method` | Certificate validation method | `string` | `\"DNS\"` | No |\n| `additional_certificate_subject_alternative_names` | Additional SANs | `list(string)` | `[]` | No |\n| `ssl_policy` | SSL policy for HTTPS | `string` | `\"ELBSecurityPolicy-TLS13-1-2-2021-06\"` | No |\n\n### HTTP/HTTPS Listener Configuration\n\n| Variable | Description | Type | Default | Required |\n|----------|-------------|------|---------|----------|\n| `enable_http_listener` | Enable HTTP listener | `bool` | `true` | No |\n| `enable_https_listener` | Enable HTTPS listener | `bool` | `null` (auto) | No |\n| `http_port` | HTTP port | `number` | `80` | No |\n| `https_port` | HTTPS port | `number` | `443` | No |\n| `http_redirect_to_https` | Redirect HTTP to HTTPS | `bool` | `null` (auto) | No |\n\n### Database Configuration\n\n| Variable | Description | Type | Default | Required |\n|----------|-------------|------|---------|----------|\n| `postgres_host` | PostgreSQL host | `string` | - | **Yes** |\n| `postgres_port` | PostgreSQL port | `number` | `5432` | No |\n| `postgres_database` | Database name | `string` | `\"n8n\"` | No |\n| `postgres_user` | Database username | `string` | `\"n8n\"` | No |\n\n### Redis Configuration\n\n| Variable | Description | Type | Default | Required |\n|----------|-------------|------|---------|----------|\n| `upstash_redis_host` | Upstash Redis host | `string` | `\"\"` | No |\n| `upstash_redis_port` | Upstash Redis port | `number` | `6379` | No |\n| `redis_url` | Full Redis URL | `string` | `\"\"` | No |\n| `redis_url_ssm_parameter` | SSM parameter with Redis URL | `string` | `\"\"` | No |\n| `redis_host` | Traditional Redis host | `string` | `\"\"` | No |\n| `redis_port` | Traditional Redis port | `number` | `6379` | No |\n\n### N8N Application Configuration\n\n| Variable | Description | Type | Default | Required |\n|----------|-------------|------|---------|----------|\n| `n8n_image` | N8N Docker image | `string` | `\"jj6584/n8n-custom:0.0.1\"` | No |\n| `n8n_host` | N8N host domain | `string` | - | **Yes** |\n| `n8n_protocol` | N8N protocol | `string` | `\"https\"` | No |\n| `n8n_basic_auth_active` | Enable basic auth | `string` | `\"true\"` | No |\n| `n8n_basic_auth_user` | Basic auth username | `string` | `\"admin\"` | No |\n| `n8n_executions_mode` | Execution mode | `string` | `\"queue\"` | No |\n\n## Outputs\n\n### Application Access\n\n| Output | Description |\n|--------|-------------|\n| `n8n_url` | Primary N8N application URL |\n| `n8n_alb_url` | Direct ALB URL |\n| `load_balancer_dns_name` | ALB DNS name |\n| `alb_dns_name` | Alias for ALB DNS name |\n\n### SSL Certificate Information\n\n| Output | Description |\n|--------|-------------|\n| `ssl_certificate` | Complete certificate information |\n| `ssl_certificate_arn` | Certificate ARN used |\n| `acm_certificate_arn` | Created certificate ARN (if any) |\n\n### Infrastructure\n\n| Output | Description |\n|--------|-------------|\n| `cluster_name` | ECS cluster name |\n| `security_group_id` | ECS tasks security group ID |\n| `target_group_arn` | ALB target group ARN |\n| `task_role_arn` | ECS task role ARN |\n| `execution_role_arn` | ECS execution role ARN |\n\n## SSL Certificate Management\n\nThis module provides three methods for SSL certificate management:\n\n### 1. Automatic Certificate Lookup\nThe module can automatically find existing ACM certificates by domain name:\n\n```hcl\ncertificate_domain_name = \"n8n.example.com\"\n```\n\n### 2. Automatic Certificate Creation\nCreate new ACM certificates with DNS validation:\n\n```hcl\ncertificate_domain_name = \"n8n.example.com\"\ncreate_acm_certificate = true\ncertificate_validation_method = \"DNS\"\n```\n\n### 3. Existing Certificate ARN\nUse an existing certificate by providing its ARN:\n\n```hcl\nssl_certificate_arn = \"arn:aws:acm:region:account:certificate/cert-id\"\n```\n\n## External Service Integration\n\n### PostgreSQL Database\n\nThe module supports any PostgreSQL-compatible database:\n\n- **Amazon RDS PostgreSQL** (recommended for production)\n- **External PostgreSQL instances**\n- **Self-managed PostgreSQL**\n\n### Redis Configuration\n\nSupports multiple Redis configurations:\n\n#### Upstash Redis (Recommended for Serverless)\n```hcl\nupstash_redis_host = \"calm-aphid-47308.upstash.io\"\nupstash_redis_port = 6379\n# Token stored in SSM: /upstash/redis/token\n```\n\n#### Traditional Redis (ElastiCache, self-managed)\n```hcl\nredis_host = \"my-cluster.abc123.cache.amazonaws.com\"\nredis_port = 6379\nredis_password_ssm_parameter = \"/redis/password\"\n```\n\n#### Redis URL Format (Complete configuration)\n```hcl\nredis_url_ssm_parameter = \"/redis/complete-url\"\n# SSM parameter contains: redis://default:password@host:port\n```\n\n## Security\n\n### Secrets Management\n\nAll sensitive data should be stored in AWS SSM Parameter Store:\n\n```hcl\nn8n_secrets = [\n  {\n    name      = \"N8N_BASIC_AUTH_PASSWORD\"\n    valueFrom = \"arn:aws:ssm:region:account:parameter/n8n/auth/password\"\n  },\n  {\n    name      = \"DB_POSTGRESDB_PASSWORD\"\n    valueFrom = \"arn:aws:ssm:region:account:parameter/n8n/db/password\"\n  },\n  {\n    name      = \"N8N_ENCRYPTION_KEY\"\n    valueFrom = \"arn:aws:ssm:region:account:parameter/n8n/encryption/key\"\n  }\n]\n\ntask_secrets_arns = [\n  \"arn:aws:ssm:region:account:parameter/n8n/auth/password\",\n  \"arn:aws:ssm:region:account:parameter/n8n/db/password\",\n  \"arn:aws:ssm:region:account:parameter/n8n/encryption/key\"\n]\n```\n\n### Network Security\n\n- **Security Groups**: Automatic creation with minimal required access\n- **Private Subnets**: ECS tasks run in private subnets\n- **Public ALB**: Load balancer in public subnets for internet access\n- **Database Access**: Restricted to ECS tasks only\n\n## Cost Optimization\n\n### Resource Sizing\n\n- **ECS Tasks**: Optimized CPU/memory allocation\n- **EC2 Instances**: Right-sized for workload\n- **Auto Scaling**: Responsive to demand\n\n### Default Resource Allocation\n\n| Component | CPU (units) | Memory (MB) | Notes |\n|-----------|-------------|-------------|---------|\n| N8N Main | 384 | 768 | Handles web UI and API |\n| N8N Worker | 256 | 512 | Processes workflows (optional) |\n| EC2 Instance | t3.small | 2GB | Cost-effective for small workloads |\n\n## Monitoring and Logging\n\n### CloudWatch Integration\n\n- **Application Logs**: ECS task logs sent to CloudWatch\n- **ALB Logs**: Access logs for debugging (optional)\n- **Metrics**: ECS, ALB, and custom application metrics\n\n### Health Checks\n\n- **ALB Health Check**: HTTP `/healthz` endpoint\n- **ECS Health Check**: Container-level health monitoring\n- **Auto Recovery**: Unhealthy tasks automatically replaced\n\n## Troubleshooting\n\n### Common Issues\n\n1. **Certificate Not Found**\n   - Ensure domain name exactly matches certificate\n   - Check certificate is in same region as ALB\n   - Verify certificate status is \"Issued\"\n\n2. **Database Connection Failed**\n   - Check security groups allow port 5432\n   - Verify database credentials in SSM\n   - Ensure database is accessible from ECS subnets\n\n3. **Redis Connection Issues**\n   - Verify Redis host/port configuration\n   - Check Upstash token in `/upstash/redis/token`\n   - Ensure Redis allows connections from ECS\n\n4. **ALB Not Accessible**\n   - Check load balancer subnets are public\n   - Verify internet gateway attached to VPC\n   - Ensure security groups allow ports 80/443\n\n### Debugging Commands\n\n```bash\n# Check ECS service status\naws ecs describe-services --cluster CLUSTER_NAME --services SERVICE_NAME\n\n# View task logs\naws logs get-log-events --log-group-name \"/ecs/ENV-PROJECT/n8n\"\n\n# Check ALB targets\naws elbv2 describe-target-health --target-group-arn TARGET_GROUP_ARN\n\n# Verify certificate\naws acm describe-certificate --certificate-arn CERT_ARN\n```\n\n## Examples\n\nSee the [applications directory](../../apps/) for complete deployment examples:\n\n- **Production Deployment**: Full production setup with RDS and Upstash\n- **Development Setup**: Simplified configuration for testing\n- **Multi-Environment**: Shared infrastructure with environment-specific configs\n\n## Related Modules\n\n- **[Enhanced ECS Module](../../modules/AWS/ecs/)** - Underlying ECS infrastructure\n- **[RDS Module](../../modules/AWS/rds/)** - PostgreSQL database\n- **[Applications](../../apps/)** - Complete deployment examples\n